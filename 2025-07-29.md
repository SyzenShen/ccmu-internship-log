## 🧬 实习日志 第17天｜定制基因组构建与比对准备

**日期：2025年7月29日**
**地点：首都医科大学生信实验室，Mac 端 VSCode + Linux 服务器终端**

---

### 🔬 核心任务目标

将环状病毒 **TTMV\_restart1000** 的序列片段（MN772835.1:334-1788）插入至人类参考基因组 **GRCh38** 染色体17的 `chr17:40332557-40332584` 区域，构建定制化参考基因组，并为后续患者数据比对做准备。

---

### 📌 今日工作内容

#### 1. Python 脚本调试与使用

* ✅ **理解并执行 `insert_virus.py` 脚本**

  * 明确脚本参数结构（共6个参数）：

    ```bash
    python insert_virus.py <human_ref.fa> <virus_seq.fa> <output.fa> <chrom> <start> <end>
    ```
  * 修复运行错误，确认参数来源为命令行，而非文件读取。
  * 跑通脚本，生成插入病毒序列后的新参考基因组 `GRCh38_TTMV_inserted.fa`。

#### 2. 环境配置排障

* ✅ **解决 pip 和 biopython 缺失问题**

  * 创建新虚拟环境并补全缺失组件：

    ```bash
    python3 -m ensurepip --upgrade
    python3 -m pip install biopython
    ```

#### 3. 病毒片段提取与验证

* ✅ **从病毒基因组中提取目标序列段**

  * 使用 `samtools faidx` 提取 `MN772835.1:334-1788` 区间：

    ```bash
    samtools faidx TTMV_restart1000.fa MN772835.1:334-1788 > virus_insert.fa
    ```
  * 验证序列长度为 `1455 bp`，格式和内容符合预期。

#### 4. 参考基因组插入操作与验证

* ✅ **病毒片段成功插入 GRCh38**

  * 替换 `chr17:40332557-40332584` 区域（28bp）为病毒片段（1455bp）；
  * 长度变化为 `+1427 bp`；
  * 新的参考基因组成功写入 `GRCh38_TTMV_inserted.fa`。

#### 5. 索引构建与比对启动

* ✅ **使用 BWA 与 Samtools 建立索引**

  ```bash
  bwa index GRCh38_TTMV_inserted.fa
  samtools faidx GRCh38_TTMV_inserted.fa
  ```
* ⏳ **运行 BWA MEM 进行全量比对**

  ```bash
  bwa mem -t 32 GRCh38_TTMV_inserted.fa zzq_1.trim.fq.gz zzq_2.trim.fq.gz > realigned.sam
  ```

---

### 📂 今日输出文件列表

| 文件名                         | 描述                |
| --------------------------- | ----------------- |
| `virus_insert.fa`           | 提取的病毒片段序列（1455bp） |
| `GRCh38_TTMV_inserted.fa`   | 含病毒插入的定制化参考基因组    |
| `*.bwt`, `*.amb`, `*.ann` 等 | BWA 索引文件          |
| `*.fai`                     | FASTA 索引文件        |
| `realigned.sam`             | BWA 比对结果（生成中）     |

---

### 🔍 问题记录与解决情况

| 问题                    | 原因                      | 解决方案                                        |
| --------------------- | ----------------------- | ------------------------------------------- |
| Python 脚本报“参数数量不正确”   | 未在 VSCode debug 模式中传入参数 | 改为命令行运行，并传入6个必需参数                           |
| pip 与 Biopython 缺失    | 虚拟环境不完整                 | 使用 `ensurepip` + `pip install biopython` 补全 |
| 提取失败提示 `fai_build` 错误 | FASTA 文件未建索引或路径错误       | 补建 `.fai`，并检查文件名无误                          |

---

### ✅ 今日总结

今天完成了从病毒序列提取到定制参考基因组生成的完整流程，并成功启动比对任务。Python 脚本的使用逐渐熟练，已能排查参数与环境类错误，自主定位运行问题。整个流程的逻辑变得清晰，后续分析将在此基础上展开。

---

### 📌 明日计划

1. **完成 realigned.sam 的 BAM 转换与排序**
2. **在 IGV 中查看病毒插入位置（chr17:40333740-40333804）**
3. **确认是否修复患者数据中观察到的缺口**
4. **写 bash 脚本封装整合流程，提高复用性**
5. **阅读更多的论文**

