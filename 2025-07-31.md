🧬 **实习日志 第19天｜病毒插入修复与自动化脚本调试**
**日期：2025年7月31日**
**地点：首都医科大学生信实验室，服务器终端（iTerm2）**

---

💡 **今日完成的工作：**

1. **病毒序列提取**

   * 使用命令：

     ```bash
     samtools faidx TTMV_restart1000.fa MN772835.1:789-1915 > virus_insert_new.fa
     ```
   * 提取区域：MN772835.1 第 789 到 1915 位
   * 实际长度为 1127 bp，已通过 `seqkit fx2tab` 核实符合预期。

2. **发现插入区空缺问题**

   * 在 IGV 中查看插入后参考基因组（chr17:40332556-40333012）出现 456 bp 的断裂；
   * 实际替换区域为 40332556-40333012（长度为 456 bp），而插入的病毒序列为 1127 bp，长度不一致；
   * 因原始脚本中切割右侧序列仍按旧终止点截取，导致连接错误，插入点不连贯。

3. **修改 Python 插入脚本**

   * 关键修正逻辑：

     ```python
     new_end = start + virus_length - 1
     right_part = record.seq[new_end:]
     ```
   * 功能优化：

     * 根据病毒序列长度动态计算新的插入终止坐标；
     * 自动截取插入点右侧的新起始位置；
     * 记录日志时输出病毒长度、插入点调整情况。

4. **问题定位与解决路径可视化**

   ```mermaid
   graph TD
       A[发现456bp空缺] --> B{原因分析}
       B --> C[切割长度≠病毒长度]
       C --> D[修改切割逻辑]
       D --> E[自动计算 new_end=start+virus_length-1]
       E --> F[验证新位置有效性]
       F --> G[生成无缝连接序列]
   ```

5. **新脚本测试准备就绪**

   * 程序输入参数如下：

     ```bash
     python insert_virus.py GRCh38.fa virus_insert_new.fa output.fa chr17 40332556 40333012
     ```
   * 输出文件为 `output.fa`，插入序列应在 chr17 的 40332556 开始处连续连接；
   * 下一步将在 IGV 中验证新插入区域是否恢复连续。

---

🔧 **关键技术要点回顾：**

* 使用 `samtools faidx` 精确提取 FASTA 区域；
* 插入时需 **严格匹配** 替换区域与插入序列长度；
* `start + len(virus_seq) - 1` 是新的右侧连接起点逻辑基础；
* Python 脚本操作 `.seq` 字段时要格外注意坐标偏移和边界。

---

🧠 **今日收获：**

* 深刻理解了“基因组断裂”可能由插入逻辑失误引起；
* 掌握了如何将病毒序列与人类基因组进行无缝融合；
* 提高了调试 Python 脚本能力，尤其在生信数据处理中的实战能力；
* 通过 mermaid 流程图清晰梳理了问题定位与解决的完整路径；
* 阅读了病毒分子对接与转录组分析的部分方法章节，初步理解研究框架。

---

❗ **问题与不足：**

* 初次插入逻辑未考虑病毒长度对右侧基因组的影响；
* 病毒序列提取时未设自动化校验机制，仍依赖人工判断；
* 还未完成对最终插入效果的 IGV 验证，比对工作待开展。

---

📌 **明日计划预告：**

1. 用修正后脚本生成新的参考基因组；
2. 用 `bwa mem` 和 `samtools` 对原始样本重新比对；
3. 在 IGV 检查插入点是否恢复连续性；
4. 若成功，继续 Delly 分析结构变异并生成新的 VCF 文件；
5. 整理病毒插入 → 比对 → IGV → 变异提取的完整流程脚本并文档化。
